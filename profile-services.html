<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moje slu≈æby - Bulldogo.cz</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
        
        // Firebase konfigurace
        const firebaseConfig = {
            apiKey: "AIzaSyA1FEmsY458LLKQLGcUaOVXsYr3Ii55QeQ",
            authDomain: "inzerio-inzerce.firebaseapp.com",
            projectId: "inzerio-inzerce",
            storageBucket: "inzerio-inzerce.appspot.com",
            messagingSenderId: "262039290071",
            appId: "1:262039290071:web:30af0eb1c65cd75e307092",
            measurementId: "G-7VD0ZE08M3"
        };
        
        // Inicializace Firebase
        const app = initializeApp(firebaseConfig);
        const firebaseAuth = getAuth(app);
        const firebaseDb = getFirestore(app);
        const analytics = getAnalytics(app);
        
        // Export pro glob√°ln√≠ pou≈æit√≠
        window.firebaseApp = app;
        window.firebaseAuth = firebaseAuth;
        window.firebaseDb = firebaseDb;
    </script>
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <!-- Logo Section -->
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">B</div>
                <span class="logo-text">
                    <span class="logo-bull">ULL</span>
                    <span class="logo-dogo">DOGO</span>
                </span>
            </div>
            <div class="header-buttons">
            </div>
        </div>

        <!-- Navigation Section -->
        <div class="navigation-section">
            <h3 class="nav-section-title">NAVIGACE</h3>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home nav-icon"></i>
                        <span class="nav-text">Dom≈Ø</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="services.html" class="nav-link">
                        <i class="fas fa-list-alt nav-icon"></i>
                        <span class="nav-text">Slu≈æby</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="my-ads.html" class="nav-link">
                        <i class="fas fa-user nav-icon"></i>
                        <span class="nav-text">M√© inzer√°ty</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="index.html#about" class="nav-link">
                        <i class="fas fa-info-circle nav-icon"></i>
                        <span class="nav-text">O n√°s</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="index.html#contact" class="nav-link">
                        <i class="fas fa-envelope nav-icon"></i>
                        <span class="nav-text">Kontakt</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="chat.html" class="nav-link">
                        <i class="fas fa-comment-alt nav-icon"></i>
                        <span class="nav-text">Chat</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="top-ads.html" class="nav-link">
                        <i class="fas fa-fire nav-icon"></i>
                        <span class="nav-text">Topov√°n√≠</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="packages.html" class="nav-link">
                        <i class="fas fa-box nav-icon"></i>
                        <span class="nav-text">Bal√≠ƒçky</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Auth Buttons Section (shown when not logged in) -->
        <div class="auth-section" id="authSection">
            <button class="btn-login" onclick="showAuthModal('login')">
                <i class="fas fa-sign-in-alt"></i>
                <span>P≈ôihl√°≈°en√≠</span>
            </button>
            <button class="btn-register" onclick="showAuthModal('register')">
                <i class="fas fa-user-plus"></i>
                <span>Registrace</span>
            </button>
        </div>

        <!-- User Profile Section (shown when logged in) -->
        <div class="user-profile-section" id="userProfileSection" style="display: none;">
            <button class="btn-profile" onclick="window.location.href='profile.html'">
                <i class="fas fa-user-circle"></i>
                <span>Profil</span>
            </button>
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Odhl√°sit se</span>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Toggle Button (when collapsed) -->
    <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content Wrapper -->
    <div class="main-content">
        <!-- Profile Hero Section -->
        <section class="page-hero">
            <div class="container">
                <div class="page-hero-card">
                    <div class="page-hero-inner">
                        <h2 class="services-title"><span class="title-text">Moje slu≈æby</span><span class="title-accent"></span></h2>
                        <p class="page-hero-subtitle">Spr√°va va≈°ich nab√≠zen√Ωch slu≈æeb</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Statistics Cards -->
        <section class="profile-stats-section">
            <div class="container">
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-ad"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">12</div>
                            <div class="stat-label">Aktivn√≠ inzer√°ty</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">4.8</div>
                            <div class="stat-label">Hodnocen√≠</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn" onclick="window.location.href='profile.html'">P≈ôehled</button>
            <button class="tab-btn active">Moje slu≈æby</button>
            <button class="tab-btn" onclick="window.location.href='profile-ratings.html'">Hodnocen√≠</button>
            <button class="tab-btn" onclick="window.location.href='profile-settings.html'">Nastaven√≠</button>
            <button class="tab-btn" onclick="window.location.href='profile-plan.html'">Spravovat bal√≠ƒçek</button>
            <button class="tab-btn" onclick="window.location.href='top-ads.html'">Topov√°n√≠</button>
        </div>

        <!-- Services Content -->
        <div class="services-content">
            <div class="services-header">
                <h2 class="services-title">Moje slu≈æby</h2>
                <button class="btn-add-service">
                    <i class="fas fa-plus"></i>
                    P≈ôidat slu≈æbu
                </button>
            </div>

            <div class="services-grid">
                <!-- Slu≈æby se naƒçtou dynamicky z Firebase -->
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="auth.js"></script>
    <script src="cities.js"></script>
    <script src="click-spark.js"></script>
    <script>
        // Initialize auth state for profile page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Profile services page loaded');
            loadUserServices();
            loadUserProfile();
        });

        // Load user profile data
        async function loadUserProfile() {
            console.log('üîß Loading user profile...');
            try {
                // Wait for Firebase to be available
                const checkFirebase = setInterval(() => {
                    console.log('üîç Checking Firebase:', {
                        firebaseAuth: !!window.firebaseAuth,
                        firebaseDb: !!window.firebaseDb
                    });
                    if (window.firebaseAuth && window.firebaseDb) {
                        console.log('‚úÖ Firebase available, loading data');
                        clearInterval(checkFirebase);
                        loadUserData();
                        
                        // Listen for auth state changes
                        window.firebaseAuth.onAuthStateChanged((user) => {
                            console.log('üë§ Auth state changed on profile page:', user ? user.email : 'Not logged in');
                            if (user) {
                                loadUserData();
                            }
                        });
                    }
                }, 100);
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ profilu:', error);
            }
        }

        async function loadUserServices() {
            try {
                // Wait for Firebase to be available
                const checkFirebase = setInterval(() => {
                    if (window.firebaseAuth && window.firebaseDb) {
                        clearInterval(checkFirebase);
                        loadServicesData();
                    }
                }, 100);
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ slu≈æeb:', error);
            }
        }

        async function loadServicesData() {
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    console.log('U≈æivatel nen√≠ p≈ôihl√°≈°en');
                    return;
                }

                console.log('Naƒç√≠t√°m slu≈æby pro u≈æivatele:', currentUser.uid);

                // Load user ads from Firestore
                const { getDocs, collection } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const adsRef = collection(window.firebaseDb, 'users', currentUser.uid, 'inzeraty');
                const adsSnapshot = await getDocs(adsRef);
                
                const userAds = [];
                adsSnapshot.forEach((doc) => {
                    userAds.push({ id: doc.id, ...doc.data() });
                });

                // Update services display
                updateServicesDisplay(userAds);

            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat slu≈æeb:', error);
            }
        }

        function updateServicesDisplay(userAds) {
            const servicesContainer = document.querySelector('.services-grid');
            if (!servicesContainer) return;

            if (userAds.length === 0) {
                servicesContainer.innerHTML = `
                    <div class="no-services">
                        <i class="fas fa-plus-circle"></i>
                        <h3>Zat√≠m nem√°te ≈æ√°dn√© slu≈æby</h3>
                        <p>Zaƒçnƒõte t√≠m, ≈æe p≈ôid√°te svou prvn√≠ slu≈æbu!</p>
                        <div class="no-services-actions">
                            <a href="services.html" class="btn btn-primary">P≈ôidat slu≈æbu</a>
                        </div>
                    </div>
                `;
                return;
            }

            servicesContainer.innerHTML = userAds.map(ad => createServiceCard(ad)).join('');
        }

        function createServiceCard(ad) {
            const categoryNames = {
                'home_craftsmen': 'Dom√°cnost & ≈òemesln√≠ci',
                'auto_moto': 'Auto & Moto',
                'garden_exterior': 'Zahrada & Exteri√©r',
                'education_tutoring': 'Vzdƒõl√°v√°n√≠ & Douƒçov√°n√≠',
                'it_technology': 'IT & technologie',
                'health_personal_care': 'Zdrav√≠ a Osobn√≠ p√©ƒçe',
                'gastronomy_catering': 'Gastronomie & Catering',
                'events_entertainment': 'Ud√°losti & Z√°bava',
                'personal_small_jobs': 'Osobn√≠ slu≈æby & drobn√© pr√°ce',
                'auto_moto_transport': 'Auto - moto doprava',
                'hobby_creative': 'Hobby & kreativn√≠ slu≈æby',
                'law_finance_admin': 'Pr√°vo & finance & administrativa',
                'pets': 'Dom√°c√≠ zv√≠≈ôata',
                'specialized_custom': 'Specializovan√© slu≈æby na p≈ô√°n√≠'
            };

            const statusColors = {
                'active': '#28a745',
                'inactive': '#dc3545',
                'paused': '#ffc107'
            };

            const statusTexts = {
                'active': 'Aktivn√≠',
                'inactive': 'Neaktivn√≠',
                'paused': 'Pozastaveno'
            };

            return `
                <div class="service-card">
                    <div class="service-image">
                        <i class="fas fa-${getCategoryIcon(ad.category)}"></i>
                    </div>
                    <div class="service-content">
                        <h3 class="service-title">${ad.title}</h3>
                        <p class="service-description">${ad.description}</p>
                        <div class="service-meta">
                            <span class="service-price">${ad.price || 'Cena na dotaz'}</span>
                            <span class="service-rating">
                                <i class="fas fa-star"></i>
                                ${ad.rating || 'N/A'} (${ad.reviews || 0} hodnocen√≠)
                            </span>
                        </div>
                        <div class="service-status" style="background-color: ${statusColors[ad.status]}; color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem; margin: 0.5rem 0;">
                            ${statusTexts[ad.status] || ad.status}
                        </div>
                        <div class="service-actions">
                            <button class="btn-edit" onclick="editService('${ad.id}')">
                                <i class="fas fa-edit"></i>
                                Upravit
                            </button>
                            <button class="btn-deactivate" onclick="toggleServiceStatus('${ad.id}', '${ad.status}')">
                                <i class="fas fa-${ad.status === 'active' ? 'pause' : 'play'}"></i>
                                ${ad.status === 'active' ? 'Deaktivovat' : 'Aktivovat'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getCategoryIcon(category) {
            const icons = {
                'home_craftsmen': 'tools',
                'auto_moto': 'car',
                'garden_exterior': 'tree',
                'education_tutoring': 'graduation-cap',
                'it_technology': 'laptop',
                'health_personal_care': 'heart',
                'gastronomy_catering': 'utensils',
                'events_entertainment': 'music',
                'personal_small_jobs': 'user-cog',
                'auto_moto_transport': 'truck',
                'hobby_creative': 'paint-brush',
                'law_finance_admin': 'calculator',
                'pets': 'paw',
                'specialized_custom': 'cog'
            };
            return icons[category] || 'briefcase';
        }

        // Service management functions
        function editService(serviceId) {
            console.log('Edit service:', serviceId);
            // Redirect to edit page or open modal
            window.location.href = `my-ads.html?edit=${serviceId}`;
        }

        async function toggleServiceStatus(serviceId, currentStatus) {
            try {
                const { updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                
                await updateDoc(doc(window.firebaseDb, 'users', window.firebaseAuth.currentUser.uid, 'inzeraty', serviceId), {
                    status: newStatus,
                    updatedAt: new Date()
                });
                
                showMessage(`Slu≈æba byla ${newStatus === 'active' ? 'aktivov√°na' : 'pozastavena'}!`, 'success');
                loadServicesData(); // Reload data
                
            } catch (error) {
                console.error('Chyba p≈ôi zmƒõnƒõ stavu slu≈æby:', error);
                showMessage('Nepoda≈ôilo se zmƒõnit stav slu≈æby.', 'error');
            }
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Load actual user data
        async function loadUserData() {
            console.log('üíæ Loading user data...');
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    console.log('‚ö†Ô∏è U≈æivatel nen√≠ p≈ôihl√°≈°en');
                    return;
                }

                console.log('üë§ Naƒç√≠t√°m data pro u≈æivatele:', currentUser.uid);

                // Load user profile from Firestore
                const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                const profileSnap = await getDoc(profileRef);
                
                let userProfile = null;
                if (profileSnap.exists()) {
                    userProfile = profileSnap.data();
                }

                // Load user ads to get statistics
                const { getDocs, collection } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const adsRef = collection(window.firebaseDb, 'users', currentUser.uid, 'inzeraty');
                const adsSnapshot = await getDocs(adsRef);
                
                const userAds = [];
                adsSnapshot.forEach((doc) => {
                    userAds.push({ id: doc.id, ...doc.data() });
                });

                // Update statistics
                console.log('üìä Calling updateStatistics with:', { userAds: userAds.length, userProfile });
                updateStatistics(userAds, userProfile);
                
                // Load all reviews and update rating after loading
                loadAllUserReviews(currentUser.uid);

            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat u≈æivatele:', error);
            }
        }

        // Update statistics with real data
        function updateStatistics(userAds, userProfile) {
            console.log('üìä Updating statistics:', { userAds, userProfile });
            
            // Active ads count
            const activeAds = userAds ? userAds.filter(ad => ad.status === 'active').length : 0;
            const activeAdsElement = document.querySelector('.stat-card:nth-child(1) .stat-number');
            if (activeAdsElement) {
                activeAdsElement.textContent = activeAds > 0 ? activeAds : '-';
                console.log('üìù Updated active ads:', activeAds);
            }

            // Rating will be updated after loading reviews
            const ratingElement = document.querySelector('.stat-card:nth-child(2) .stat-number');
            if (ratingElement) {
                ratingElement.textContent = '-';
            }
            
            console.log('‚úÖ Statistics updated');
        }

        // Load all user reviews (profile + ads)
        async function loadAllUserReviews(userId) {
            console.log('‚≠ê Loading all reviews for user:', userId);
            try {
                const { getDocs, collection, collectionGroup } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                // Load profile reviews
                const profileReviewsRef = collection(window.firebaseDb, 'users', userId, 'reviews');
                const profileSnap = await getDocs(profileReviewsRef);
                const profileReviews = profileSnap.docs.map(d => ({ 
                    id: d.id, 
                    ...d.data(),
                    type: 'profile'
                }));

                // Load ad reviews using collectionGroup
                const adReviewsGroup = collectionGroup(window.firebaseDb, 'reviews');
                const adReviews = [];
                const groupSnap = await getDocs(adReviewsGroup);
                groupSnap.forEach(docSnap => {
                    const parent = docSnap.ref.parent; // reviews collection
                    const adDoc = parent?.parent; // adId document
                    const inzeraty = adDoc?.parent; // 'inzeraty' collection
                    const userDoc = inzeraty?.parent; // user uid document
                    if (userDoc && userDoc.id === userId && inzeraty.id === 'inzeraty') {
                        adReviews.push({ 
                            id: docSnap.id, 
                            ...docSnap.data(),
                            type: 'ad',
                            adId: adDoc.id
                        });
                    }
                });

                // Combine all reviews
                const allReviews = [...profileReviews, ...adReviews];
                console.log('üìä Found reviews:', { 
                    profile: profileReviews.length, 
                    ads: adReviews.length, 
                    total: allReviews.length 
                });

                // Update rating in statistics after loading reviews
                updateRatingFromReviews(allReviews);

            } catch (error) {
                console.error('‚ùå Error loading reviews:', error);
            }
        }

        // Update rating in statistics from reviews
        function updateRatingFromReviews(reviews) {
            console.log('üîÑ Updating rating from reviews:', reviews.length);
            
            // Calculate average rating
            const avgRating = reviews.length > 0 ? 
                (reviews.reduce((sum, r) => sum + (r.rating || 0), 0) / reviews.length) : 0;
            
            const ratingElement = document.querySelector('.stat-card:nth-child(2) .stat-number');
            if (ratingElement) {
                if (reviews.length > 0) {
                    ratingElement.textContent = avgRating.toFixed(1);
                } else {
                    ratingElement.textContent = '-';
                }
                console.log('üìù Updated rating from reviews:', avgRating.toFixed(1), 'reviews:', reviews.length);
            }
        }

        // Export functions for global use
        window.editService = editService;
        window.toggleServiceStatus = toggleServiceStatus;
    </script>
</body>
</html>
