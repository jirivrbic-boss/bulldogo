<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platba √∫spƒõ≈°n√° - Bulldogo.cz</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .success-container {
            max-width: 600px;
            margin: 100px auto;
            padding: 2rem;
            text-align: center;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success-icon {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 1rem;
        }
        .success-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 1rem;
        }
        .success-message {
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        .success-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #ff6a00;
            color: white;
        }
        .btn-primary:hover {
            background: #e55a00;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
    </style>
    <!-- Firebase SDK -->
    <script type="module" src="firebase-init.js"></script>
    <script src="gopay-config.js"></script>
    <script src="gopay-payment-handler.js"></script>
</head>
<body>
    <div class="success-container">
        <div class="success-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h1 class="success-title">Platba byla √∫spƒõ≈°nƒõ dokonƒçena!</h1>
        <p class="success-message">
            Dƒõkujeme za va≈°i platbu. Va≈°e objedn√°vka byla √∫spƒõ≈°nƒõ zpracov√°na.
        </p>
        <div id="paymentDetails" style="margin: 2rem 0; padding: 1rem; background: #f8f9fa; border-radius: 5px; display: none;">
            <h3>Detaily platby:</h3>
            <p id="paymentInfo"></p>
        </div>
        <div id="loadingMessage" style="margin: 1rem 0; color: #666;">
            <i class="fas fa-spinner fa-spin"></i> Zpracov√°v√°m informace o platbƒõ...
        </div>
        <div class="success-actions">
            <a href="packages.html" class="btn btn-primary">
                <i class="fas fa-box"></i> Zpƒõt na bal√≠ƒçky
            </a>
            <a href="my-ads.html" class="btn btn-secondary">
                <i class="fas fa-list"></i> M√© inzer√°ty
            </a>
            <a href="index.html" class="btn btn-secondary">
                <i class="fas fa-home"></i> Dom≈Ø
            </a>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">P≈ôihl√°≈°en√≠</h2>
                <span class="close" onclick="closeAuthModal()">&times;</span>
            </div>
            <form id="authForm" class="auth-form">
                <!-- V√Ωbƒõr typu registrace (pouze p≈ôi registraci) -->
                <div class="form-group registration-type" style="display: none;">
                    <label class="form-label">Typ registrace:</label>
                    <div class="registration-type-buttons">
                        <button type="button" class="registration-type-btn active" data-type="person">
                            <i class="fas fa-user"></i> Hobby (fyzick√° osoba)
                        </button>
                        <button type="button" class="registration-type-btn" data-type="company">
                            <i class="fas fa-building"></i> Firma
                        </button>
                    </div>
                </div>

                <!-- Formul√°≈ô pro fyzickou osobu -->
                <div class="person-form" style="display: none;">
                    <div class="form-group">
                        <input type="text" id="firstName" name="firstName" placeholder="Jm√©no" required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="lastName" name="lastName" placeholder="P≈ô√≠jmen√≠" required>
                    </div>
                    <div class="form-group">
                        <input type="tel" id="phone" name="phone" placeholder="Telefon" required>
                    </div>
                    <div class="form-group">
                        <input type="date" id="birthDate" name="birthDate" placeholder="Datum narozen√≠" required>
                    </div>
                </div>

                <!-- Formul√°≈ô pro firmu -->
                <div class="company-form" style="display: none;">
                    <div class="form-group">
                        <input type="text" id="companyName" name="companyName" placeholder="Obchodn√≠ n√°zev">
                    </div>
                    <div class="form-group">
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="text" id="ico" name="ico" placeholder="Iƒå" style="flex:1;">
                            <button type="button" id="btnVerifyICO" class="btn">Ovƒõ≈ôit</button>
                        </div>
                        <div id="icoStatus" style="font-size:13px; margin-top:4px; color:#6b7280;"></div>
                    </div>
                    <div class="form-group">
                        <input type="text" id="dic" name="dic" placeholder="DIƒå (voliteln√©)" data-optional="true">
                    </div>
                    <div class="form-group">
                        <input type="tel" id="companyPhone" name="companyPhone" placeholder="Telefon">
                    </div>
                    <div class="form-group">
                        <input type="text" id="companyAddress" name="companyAddress" placeholder="S√≠dlo firmy">
                    </div>
                </div>

                <!-- Spoleƒçn√° pole -->
                <div class="form-group">
                    <input type="email" id="email" name="email" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" name="password" placeholder="Heslo" required>
                </div>
                <button type="button" id="btnSendPhoneCode" class="btn btn-primary auth-submit-btn" style="display:none;">Pokraƒçovat na ovƒõ≈ôen√≠ telefonn√≠ho ƒç√≠sla</button>
                <button type="submit" class="btn btn-primary auth-submit-btn" id="btnAuthSubmit">P≈ôihl√°sit se</button>
                <div id="phoneStep2" style="display:none; margin-top:8px;">
                    <div class="form-group">
                        <input type="text" id="smsCode" inputmode="numeric" placeholder="K√≥d z SMS">
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button type="button" id="btnVerifyPhoneCode" class="btn btn-primary">Ovƒõ≈ôit k√≥d a dokonƒçit registraci</button>
                        <button type="button" id="btnPhoneBack" class="btn">Zpƒõt</button>
                    </div>
                </div>
                <div id="recaptcha-container" style="height:0; overflow:hidden;"></div>
            </form>
            <div class="auth-switch">
                <button type="button" class="auth-switch-btn" data-type="register">Nem√°te √∫ƒçet? Zaregistrujte se</button>
            </div>
        </div>
    </div>

    <!-- Auth scripts for modal -->
    <script src="script.js"></script>
    <script src="auth.js"></script>
    <script>
        // Zpracov√°n√≠ informac√≠ o platbƒõ z GoPay
        document.addEventListener('DOMContentLoaded', async function() {
            const loadingMessage = document.getElementById('loadingMessage');
            const paymentDetails = document.getElementById('paymentDetails');
            const paymentInfo = document.getElementById('paymentInfo');
            
            // D≈ÆLE≈ΩIT√â: Poƒçkat na naƒçten√≠ Firebase a obnoven√≠ Auth session
            console.log('‚è≥ ƒåek√°m na Firebase inicializaci...');
            
            // Poƒçkat na Firebase
            await new Promise((resolve) => {
                if (window.firebaseAuth && window.firebaseDb) {
                    console.log('‚úÖ Firebase ji≈æ naƒçten');
                    resolve();
                } else {
                    // Poƒçkat na naƒçten√≠ Firebase
                    const checkInterval = setInterval(() => {
                        if (window.firebaseAuth && window.firebaseDb) {
                            clearInterval(checkInterval);
                            console.log('‚úÖ Firebase naƒçten');
                            resolve();
                        }
                    }, 100);
                    
                    // Timeout po 10 sekund√°ch
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        console.warn('‚ö†Ô∏è Firebase se nenaƒçetl do 10 sekund');
                        resolve();
                    }, 10000);
                }
            });
            
            // Poƒçkat na obnoven√≠ Auth session
            console.log('‚è≥ ƒåek√°m na obnoven√≠ Auth session...');
            const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            
            await new Promise((resolve) => {
                // Zkontrolovat, zda u≈æ je u≈æivatel p≈ôihl√°≈°en
                if (window.firebaseAuth.currentUser) {
                    console.log('‚úÖ U≈æivatel ji≈æ p≈ôihl√°≈°en:', window.firebaseAuth.currentUser.uid);
                    resolve();
                    return;
                }
                
                // Poƒçkat na Auth state change
                const unsubscribe = onAuthStateChanged(window.firebaseAuth, (user) => {
                    if (user) {
                        console.log('‚úÖ Auth session obnovena:', user.uid);
                        unsubscribe();
                        resolve();
                    } else {
                        // Poƒçkat maxim√°lnƒõ 5 sekund
                        setTimeout(() => {
                            console.warn('‚ö†Ô∏è U≈æivatel nen√≠ p≈ôihl√°≈°en po 5 sekund√°ch');
                            unsubscribe();
                            resolve();
                        }, 5000);
                    }
                });
            });
            
            // Zkontrolovat, zda jsou funkce dostupn√©
            if (typeof window.parseGoPayReturnParams !== 'function') {
                console.error('‚ùå parseGoPayReturnParams nen√≠ dostupn√°, ƒçek√°m na naƒçten√≠ gopay-payment-handler.js...');
                // Poƒçkat na naƒçten√≠ skriptu
                await new Promise((resolve) => {
                    const checkInterval = setInterval(() => {
                        if (typeof window.parseGoPayReturnParams === 'function') {
                            clearInterval(checkInterval);
                            console.log('‚úÖ gopay-payment-handler.js naƒçten');
                            resolve();
                        }
                    }, 100);
                    
                    // Timeout po 5 sekund√°ch
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        console.error('‚ùå gopay-payment-handler.js se nenaƒçetl do 5 sekund');
                        resolve();
                    }, 5000);
                });
            }
            
            try {
                // 1. Zpracovat URL parametry z GoPay
                const gopayParams = window.parseGoPayReturnParams();
                
                console.log('üîç Zpracov√°v√°m GoPay parametry:', gopayParams);
                console.log('üîç URL parametry:', window.location.search);
                
                // Zkontrolovat, zda jsou nƒõjak√© parametry (idPaymentSession, paymentSessionId, nebo orderNumber)
                if (gopayParams && (gopayParams.idPaymentSession || gopayParams.paymentSessionId || gopayParams.orderNumber)) {
                    console.log('‚úÖ GoPay parametry nalezeny:', gopayParams);
                    
                    // D≈ÆLE≈ΩIT√â: Pokud jsme na success str√°nce, state MUS√ç b√Ωt PAID
                    // GoPay m≈Ø≈æe vracet CANCELED i p≈ôi √∫spƒõ≈°n√© platbƒõ (kv≈Øli r≈Øzn√Ωm d≈Øvod≈Øm)
                    // Ale pokud jsme na success str√°nce, znamen√° to, ≈æe platba byla √∫spƒõ≈°n√°
                    const originalState = gopayParams.state;
                    gopayParams.state = 'PAID';
                    if (originalState && originalState !== 'PAID') {
                        console.log('‚ö†Ô∏è GoPay vr√°til state:', originalState, 'ale jsme na success str√°nce, nastavuji na PAID');
                    }
                    
                    // Pokud chyb√≠ ƒç√°stka nebo produkt, zkusit z√≠skat z konfigurace podle orderNumber
                    if (gopayParams.orderNumber) {
                        const paymentType = window.getPaymentTypeFromOrderNumber(gopayParams.orderNumber);
                        if (paymentType) {
                            const config = window.getPaymentConfig(paymentType.type, paymentType.id);
                            if (config) {
                                if (!gopayParams.totalPrice) {
                                    gopayParams.totalPrice = config.amountInHellers.toString();
                                    console.log('‚ÑπÔ∏è ƒå√°stka z√≠sk√°na z konfigurace:', config.amount, 'Kƒç');
                                }
                                if (!gopayParams.productName) {
                                    gopayParams.productName = config.productName;
                                    console.log('‚ÑπÔ∏è Produkt z√≠sk√°na z konfigurace:', config.productName);
                                }
                            }
                        }
                    }
                    
                    
                    // Zobrazit informace o platbƒõ
                    const paymentId = gopayParams.idPaymentSession || gopayParams.paymentSessionId || 'N/A';
                    // Pokud je totalPrice v hal√©≈ô√≠ch, p≈ôev√©st na Kƒç
                    let amount = 'N/A';
                    if (gopayParams.totalPrice) {
                        const totalPriceNum = parseInt(gopayParams.totalPrice);
                        // Pokud je ƒç√≠slo vƒõt≈°√≠ ne≈æ 100, pravdƒõpodobnƒõ je to v hal√©≈ô√≠ch
                        amount = totalPriceNum > 100 ? (totalPriceNum / 100).toFixed(2) : totalPriceNum.toFixed(2);
                    } else {
                        // Zkusit z√≠skat z konfigurace
                        const paymentType = window.getPaymentTypeFromOrderNumber(gopayParams.orderNumber);
                        if (paymentType) {
                            const config = window.getPaymentConfig(paymentType.type, paymentType.id);
                            if (config) {
                                amount = config.amount.toFixed(2);
                            }
                        }
                    }
                    
                    paymentDetails.style.display = 'block';
                    paymentInfo.innerHTML = `
                        ${paymentId !== 'N/A' ? `<strong>ID platby:</strong> ${paymentId}<br>` : ''}
                        <strong>Stav:</strong> ${gopayParams.state || 'PAID'}<br>
                        <strong>ƒå√°stka:</strong> ${amount} ${gopayParams.currency || 'CZK'}<br>
                        <strong>Objedn√°vka:</strong> ${gopayParams.orderNumber || 'N/A'}<br>
                        <strong>Produkt:</strong> ${gopayParams.productName || 'N/A'}<br>
                        ${gopayParams.paymentMethod ? `<strong>Zp≈Øsob platby:</strong> ${gopayParams.paymentMethod}<br>` : ''}
                    `;
                    
                    // Z√≠skat orderNumber z URL nebo sessionStorage
                    let orderNumber = gopayParams.orderNumber;
                    if (!orderNumber) {
                        // Fallback: zkusit z√≠skat z sessionStorage
                        const paymentData = sessionStorage.getItem('gopay_payment');
                        if (paymentData) {
                            try {
                                const payment = JSON.parse(paymentData);
                                orderNumber = payment.orderNumber;
                                console.log('‚ÑπÔ∏è OrderNumber z√≠sk√°no z sessionStorage:', orderNumber);
                                // P≈ôidat orderNumber do gopayParams pro dal≈°√≠ zpracov√°n√≠
                                gopayParams.orderNumber = orderNumber;
                            } catch (e) {
                                console.warn('‚ö†Ô∏è Nelze parsovat sessionStorage:', e);
                            }
                        }
                    }
                    
                    // 2. Ulo≈æit do Firestore
                    if (orderNumber) {
                        try {
                            console.log('üíæ Ukl√°d√°m platbu do Firestore...');
                            const savedOrderNumber = await window.savePaymentToFirestore(gopayParams);
                            console.log('‚úÖ Platba ulo≈æena do Firestore:', savedOrderNumber);
                        } catch (error) {
                            console.error('‚ùå Chyba p≈ôi ukl√°d√°n√≠ do Firestore:', error);
                            console.error('‚ùå Error details:', error.message, error.stack);
                        }
                        
                        // 3. Aktivovat pl√°n
                        const paymentType = window.getPaymentTypeFromOrderNumber(orderNumber);
                        console.log('üîç Payment type pro orderNumber:', orderNumber, '‚Üí', paymentType);
                        
                        if (paymentType) {
                            try {
                                console.log('üéØ Aktivuji pl√°n...', paymentType);
                                console.log('üéØ Payment info:', gopayParams);
                                
                                // Zkontrolovat, zda je u≈æivatel p≈ôihl√°≈°en
                                if (!window.firebaseAuth) {
                                    console.error('‚ùå Firebase Auth nen√≠ dostupn√Ω!');
                                    alert('Chyba: Firebase nen√≠ naƒçten. Obnovte pros√≠m str√°nku.');
                                    return;
                                }
                                
                                // Zkusit z√≠skat u≈æivatele z sessionStorage jako fallback
                                let currentUser = window.firebaseAuth.currentUser;
                                if (!currentUser) {
                                    console.warn('‚ö†Ô∏è currentUser nen√≠ dostupn√Ω, zkou≈°√≠m sessionStorage...');
                                    const userData = sessionStorage.getItem('firebase_user');
                                    if (userData) {
                                        try {
                                            const user = JSON.parse(userData);
                                            console.log('‚ÑπÔ∏è U≈æivatel z√≠sk√°na z sessionStorage:', user.uid);
                                            // Pou≈æ√≠t userId z sessionStorage
                                            currentUser = { uid: user.uid, email: user.email };
                                        } catch (e) {
                                            console.error('‚ùå Nelze parsovat user data z sessionStorage:', e);
                                        }
                                    }
                                }
                                
                                if (!currentUser) {
                                    console.error('‚ùå U≈æivatel nen√≠ p≈ôihl√°≈°en! Nelze aktivovat pl√°n.');
                                    console.error('‚ùå Firebase Auth:', window.firebaseAuth);
                                    console.error('‚ùå currentUser:', window.firebaseAuth.currentUser);
                                    
                                    const errorMsg = document.createElement('div');
                                    errorMsg.style.cssText = 'background: #dc3545; color: white; padding: 15px; margin: 10px 0; border-radius: 5px;';
                                    errorMsg.innerHTML = `
                                        <strong>‚ö†Ô∏è Chyba: Nejste p≈ôihl√°≈°eni</strong><br>
                                        Po n√°vratu z GoPay se va≈°e p≈ôihl√°≈°en√≠ neobnovilo.<br>
                                        <a href="packages.html" style="color: white; text-decoration: underline;">Kliknƒõte zde pro opƒõtovn√© p≈ôihl√°≈°en√≠</a>
                                    `;
                                    document.querySelector('.success-container').appendChild(errorMsg);
                                    return;
                                }
                                
                                console.log('‚úÖ U≈æivatel je p≈ôihl√°≈°en:', currentUser.uid);
                                
                                await window.activatePlanFromPayment(gopayParams, paymentType);
                                console.log('‚úÖ Pl√°n aktivov√°n:', paymentType);
                                
                                // Zobrazit √∫spƒõ≈°nou zpr√°vu
                                const successMsg = document.createElement('div');
                                successMsg.style.cssText = 'background: #28a745; color: white; padding: 10px; margin: 10px 0; border-radius: 5px;';
                                successMsg.innerHTML = '‚úÖ V√°≈° bal√≠ƒçek byl √∫spƒõ≈°nƒõ aktivov√°n!';
                                document.querySelector('.success-container').appendChild(successMsg);
                                
                            } catch (error) {
                                console.error('‚ùå Chyba p≈ôi aktivaci pl√°nu:', error);
                                console.error('‚ùå Error code:', error.code);
                                console.error('‚ùå Error message:', error.message);
                                console.error('‚ùå Error stack:', error.stack);
                                
                                // Zobrazit chybovou zpr√°vu
                                const errorMsg = document.createElement('div');
                                errorMsg.style.cssText = 'background: #dc3545; color: white; padding: 10px; margin: 10px 0; border-radius: 5px;';
                                errorMsg.innerHTML = '‚ö†Ô∏è Chyba p≈ôi aktivaci pl√°nu: ' + error.message + '. Kontaktujte pros√≠m podporu.';
                                document.querySelector('.success-container').appendChild(errorMsg);
                            }
                        } else {
                            console.warn('‚ö†Ô∏è Nelze naj√≠t payment type pro orderNumber:', orderNumber);
                            const errorMsg = document.createElement('div');
                            errorMsg.style.cssText = 'background: #ffc107; color: #333; padding: 10px; margin: 10px 0; border-radius: 5px;';
                            errorMsg.innerHTML = '‚ö†Ô∏è Nelze naj√≠t typ platby. Kontaktujte pros√≠m podporu.';
                            document.querySelector('.success-container').appendChild(errorMsg);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Chyb√≠ orderNumber - nelze ulo≈æit ani aktivovat pl√°n. Zkontrolujte URL parametry nebo sessionStorage.');
                    }
                    
                } else {
                    // Fallback: zkusit z√≠skat z sessionStorage
                    console.log('‚ÑπÔ∏è GoPay parametry nenalezeny, zkou≈°√≠m sessionStorage');
                    const paymentData = sessionStorage.getItem('gopay_payment');
                    if (paymentData) {
                        const payment = JSON.parse(paymentData);
                        const config = window.getPaymentConfig(payment.type, payment.id);
                        
                        if (config) {
                            paymentDetails.style.display = 'block';
                            paymentInfo.innerHTML = `
                                <strong>Typ:</strong> ${payment.type === 'package' ? 'Bal√≠ƒçek' : 'Topov√°n√≠'}<br>
                                <strong>N√°zev:</strong> ${config.productName}<br>
                                <strong>ƒå√°stka:</strong> ${config.amount} Kƒç<br>
                                <strong>Objedn√°vka:</strong> ${payment.orderNumber}
                            `;
                            
                            // Aktivovat pl√°n
                            const paymentType = { type: payment.type, id: payment.id };
                            await window.activatePlanFromPayment({ orderNumber: payment.orderNumber }, paymentType);
                        }
                    }
                }
                
                // Skr√Ωt loading
                if (loadingMessage) {
                    loadingMessage.style.display = 'none';
                }
                
                // Vyƒçistit sessionStorage
                sessionStorage.removeItem('gopay_payment');
                
                // Vyƒçistit URL parametry
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi zpracov√°n√≠ platebn√≠ch informac√≠:', error);
                if (loadingMessage) {
                    loadingMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Chyba p≈ôi zpracov√°n√≠ platby. Kontaktujte pros√≠m podporu.';
                    loadingMessage.style.color = '#dc3545';
                }
            }
        });
    </script>
</body>
</html>

