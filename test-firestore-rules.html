<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firestore Rules</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #results {
            margin-top: 20px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
    <script type="module" src="firebase-init.js"></script>
</head>
<body>
    <h1>üîç Test Firestore Rules</h1>
    <p>Tato str√°nka otestuje, jestli jsou Firestore pravidla spr√°vnƒõ nastavena a publikov√°na.</p>
    
    <button onclick="runTests()">Spustit testy</button>
    <button onclick="clearResults()">Vymazat v√Ωsledky</button>
    
    <div id="results"></div>

    <script type="module">
        const resultsDiv = document.getElementById('results');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }
        
        function clearResults() {
            resultsDiv.innerHTML = '';
        }
        
        async function waitForFirebase() {
            return new Promise((resolve) => {
                if (window.firebaseReady) {
                    resolve();
                    return;
                }
                const checkInterval = setInterval(() => {
                    if (window.firebaseReady) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
        }
        
        async function runTests() {
            clearResults();
            addResult('‚è≥ ƒåek√°m na inicializaci Firebase...', 'info');
            
            try {
                await waitForFirebase();
                addResult('‚úÖ Firebase inicializov√°n', 'success');
                
                if (!window.firebaseDb) {
                    addResult('‚ùå Firebase DB nen√≠ dostupn√Ω!', 'error');
                    return;
                }
                
                const { collection, getDocs, query, limit, collectionGroup } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                // Test 1: Z√°kladn√≠ p≈ô√≠stup k users kolekci
                addResult('üîç Test 1: Testuji p≈ô√≠stup k users kolekci...', 'info');
                try {
                    const usersRef = collection(window.firebaseDb, 'users');
                    const usersQuery = query(usersRef, limit(1));
                    const usersSnapshot = await getDocs(usersQuery);
                    addResult(`‚úÖ Test 1 √öSPƒö≈†N√ù: P≈ô√≠stup k users kolekci funguje! (naƒçteno ${usersSnapshot.size} dokument≈Ø)`, 'success');
                } catch (error) {
                    addResult(`‚ùå Test 1 SELHAL: ${error.code} - ${error.message}`, 'error');
                    if (error.code === 'permission-denied') {
                        addResult('üö® Pravidla nejsou publikov√°na nebo jsou ≈°patnƒõ nastavena!', 'error');
                        addResult('üìã ≈òE≈†EN√ç: Zkop√≠ruj pravidla z firestore-rules.txt do Firebase Console ‚Üí Firestore ‚Üí Rules ‚Üí Publish', 'error');
                    }
                }
                
                // Test 2: CollectionGroup dotaz na inzeraty
                addResult('üîç Test 2: Testuji collectionGroup("inzeraty") dotaz...', 'info');
                try {
                    const inzeratyRef = collectionGroup(window.firebaseDb, 'inzeraty');
                    const inzeratySnapshot = await getDocs(inzeratyRef);
                    addResult(`‚úÖ Test 2 √öSPƒö≈†N√ù: CollectionGroup dotaz funguje! (naƒçteno ${inzeratySnapshot.size} inzer√°t≈Ø)`, 'success');
                    
                    if (inzeratySnapshot.size === 0) {
                        addResult('‚ö†Ô∏è Dotaz funguje, ale nena≈°el ≈æ√°dn√© inzer√°ty. Zkontroluj, zda existuj√≠ dokumenty v users/{uid}/inzeraty/', 'info');
                    }
                } catch (error) {
                    addResult(`‚ùå Test 2 SELHAL: ${error.code} - ${error.message}`, 'error');
                    if (error.code === 'permission-denied') {
                        addResult('üö® CollectionGroup dotaz je blokov√°n pravidly!', 'error');
                        addResult('üìã Ujisti se, ≈æe pravidla obsahuj√≠: match /users/{userId}/inzeraty/{adId} { allow read: if true; }', 'error');
                    }
                }
                
                // Test 3: Zkusit naƒç√≠st konkr√©tn√≠ho u≈æivatele (pokud je p≈ôihl√°≈°en)
                if (window.firebaseAuth?.currentUser) {
                    addResult(`üîç Test 3: Testuji p≈ô√≠stup k inzer√°t≈Øm p≈ôihl√°≈°en√©ho u≈æivatele (${window.firebaseAuth.currentUser.uid})...`, 'info');
                    try {
                        const userAdsRef = collection(window.firebaseDb, 'users', window.firebaseAuth.currentUser.uid, 'inzeraty');
                        const userAdsSnapshot = await getDocs(userAdsRef);
                        addResult(`‚úÖ Test 3 √öSPƒö≈†N√ù: P≈ô√≠stup k vlastn√≠m inzer√°t≈Øm funguje! (naƒçteno ${userAdsSnapshot.size} inzer√°t≈Ø)`, 'success');
                    } catch (error) {
                        addResult(`‚ùå Test 3 SELHAL: ${error.code} - ${error.message}`, 'error');
                    }
                } else {
                    addResult('‚ÑπÔ∏è Test 3: P≈ôeskoƒçen (u≈æivatel nen√≠ p≈ôihl√°≈°en)', 'info');
                }
                
                // Shrnut√≠
                addResult('<hr><strong>üìä SHRNUT√ç:</strong>', 'info');
                addResult('Pokud v≈°echny testy selhaly s "permission-denied":', 'info');
                addResult('1. Zkop√≠ruj obsah z firestore-rules.txt', 'info');
                addResult('2. Jdi do Firebase Console ‚Üí Firestore Database ‚Üí Rules', 'info');
                addResult('3. Vlo≈æ pravidla a klikni na Publish', 'info');
                addResult('4. Poƒçkej 1-2 minuty a obnov tuto str√°nku', 'info');
                
            } catch (error) {
                addResult(`‚ùå Kritick√° chyba: ${error.message}`, 'error');
            }
        }
        
        window.runTests = runTests;
        window.clearResults = clearResults;
        
        // Automaticky spustit testy po naƒçten√≠
        window.addEventListener('load', () => {
            setTimeout(() => {
                runTests();
            }, 2000);
        });
    </script>
    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">P≈ôihl√°≈°en√≠</h2>
                <span class="close" onclick="closeAuthModal()">&times;</span>
            </div>
            <form id="authForm" class="auth-form">
                <!-- V√Ωbƒõr typu registrace (pouze p≈ôi registraci) -->
                <div class="form-group registration-type" style="display: none;">
                    <label class="form-label">Typ registrace:</label>
                    <div class="registration-type-buttons">
                        <button type="button" class="registration-type-btn active" data-type="person">
                            <i class="fas fa-user"></i> Hobby (fyzick√° osoba)
                        </button>
                        <button type="button" class="registration-type-btn" data-type="company">
                            <i class="fas fa-building"></i> Firma
                        </button>
                    </div>
                </div>

                <!-- Formul√°≈ô pro fyzickou osobu -->
                <div class="person-form" style="display: none;">
                    <div class="form-group">
                        <input type="text" id="firstName" name="firstName" placeholder="Jm√©no" required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="lastName" name="lastName" placeholder="P≈ô√≠jmen√≠" required>
                    </div>
                    <div class="form-group">
                        <input type="tel" id="phone" name="phone" placeholder="Telefon" required>
                    </div>
                    <div class="form-group">
                        <input type="date" id="birthDate" name="birthDate" placeholder="Datum narozen√≠" required>
                    </div>
                </div>

                <!-- Formul√°≈ô pro firmu -->
                <div class="company-form" style="display: none;">
                    <div class="form-group">
                        <input type="text" id="companyName" name="companyName" placeholder="Obchodn√≠ n√°zev">
                    </div>
                    <div class="form-group">
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="text" id="ico" name="ico" placeholder="Iƒå" style="flex:1;">
                            <button type="button" id="btnVerifyICO" class="btn">Ovƒõ≈ôit</button>
                        </div>
                        <div id="icoStatus" style="font-size:13px; margin-top:4px; color:#6b7280;"></div>
                    </div>
                    <div class="form-group">
                        <input type="text" id="dic" name="dic" placeholder="DIƒå (voliteln√©)" data-optional="true">
                    </div>
                    <div class="form-group">
                        <input type="tel" id="companyPhone" name="companyPhone" placeholder="Telefon">
                    </div>
                    <div class="form-group">
                        <input type="text" id="companyAddress" name="companyAddress" placeholder="S√≠dlo firmy">
                    </div>
                </div>

                <!-- Spoleƒçn√° pole -->
                <div class="form-group">
                    <input type="email" id="email" name="email" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" name="password" placeholder="Heslo" required>
                </div>
                <button type="button" id="btnSendPhoneCode" class="btn btn-primary auth-submit-btn" style="display:none;">Pokraƒçovat na ovƒõ≈ôen√≠ telefonn√≠ho ƒç√≠sla</button>
                <button type="submit" class="btn btn-primary auth-submit-btn" id="btnAuthSubmit">P≈ôihl√°sit se</button>
                <div id="phoneStep2" style="display:none; margin-top:8px;">
                    <div class="form-group">
                        <input type="text" id="smsCode" inputmode="numeric" placeholder="K√≥d z SMS">
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button type="button" id="btnVerifyPhoneCode" class="btn btn-primary">Ovƒõ≈ôit k√≥d a dokonƒçit registraci</button>
                        <button type="button" id="btnPhoneBack" class="btn">Zpƒõt</button>
                    </div>
                </div>
                <div id="recaptcha-container" style="height:0; overflow:hidden;"></div>
            </form>
            <div class="auth-switch">
                <button type="button" class="auth-switch-btn" data-type="register">Nem√°te √∫ƒçet? Zaregistrujte se</button>
            </div>
        </div>
    </div>
</body>
</html>

