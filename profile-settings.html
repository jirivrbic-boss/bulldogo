<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nastaven√≠ - Bulldogo.cz</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
        
        // Firebase konfigurace
        const firebaseConfig = {
            apiKey: "AIzaSyA1FEmsY458LLKQLGcUaOVXsYr3Ii55QeQ",
            authDomain: "inzerio-inzerce.firebaseapp.com",
            projectId: "inzerio-inzerce",
            storageBucket: "inzerio-inzerce.appspot.com",
            messagingSenderId: "262039290071",
            appId: "1:262039290071:web:30af0eb1c65cd75e307092",
            measurementId: "G-7VD0ZE08M3"
        };
        
        // Inicializace Firebase
        const app = initializeApp(firebaseConfig);
        const firebaseAuth = getAuth(app);
        const firebaseDb = getFirestore(app);
        const analytics = getAnalytics(app);
        
        // Export pro glob√°ln√≠ pou≈æit√≠
        window.firebaseApp = app;
        window.firebaseAuth = firebaseAuth;
        window.firebaseDb = firebaseDb;
    </script>
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <!-- Logo Section -->
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">B</div>
                <span class="logo-text">
                    <span class="logo-bull">ULL</span>
                    <span class="logo-dogo">DOGO</span>
                </span>
            </div>
            <div class="header-buttons">
            </div>
        </div>

        <!-- Navigation Section -->
        <div class="navigation-section">
            <h3 class="nav-section-title">NAVIGACE</h3>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home nav-icon"></i>
                        <span class="nav-text">Dom≈Ø</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="services.html" class="nav-link">
                        <i class="fas fa-list-alt nav-icon"></i>
                        <span class="nav-text">Slu≈æby</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="my-ads.html" class="nav-link">
                        <i class="fas fa-user nav-icon"></i>
                        <span class="nav-text">M√© inzer√°ty</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="index.html#about" class="nav-link">
                        <i class="fas fa-info-circle nav-icon"></i>
                        <span class="nav-text">O n√°s</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="index.html#contact" class="nav-link">
                        <i class="fas fa-envelope nav-icon"></i>
                        <span class="nav-text">Kontakt</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="chat.html" class="nav-link">
                        <i class="fas fa-comment-alt nav-icon"></i>
                        <span class="nav-text">Chat</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="top-ads.html" class="nav-link">
                        <i class="fas fa-fire nav-icon"></i>
                        <span class="nav-text">Topov√°n√≠</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="packages.html" class="nav-link">
                        <i class="fas fa-box nav-icon"></i>
                        <span class="nav-text">Bal√≠ƒçky</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Auth Buttons Section (shown when not logged in) -->
        <div class="auth-section" id="authSection">
            <button class="btn-login" onclick="showAuthModal('login')">
                <i class="fas fa-sign-in-alt"></i>
                <span>P≈ôihl√°≈°en√≠</span>
            </button>
            <button class="btn-register" onclick="showAuthModal('register')">
                <i class="fas fa-user-plus"></i>
                <span>Registrace</span>
            </button>
        </div>

        <!-- User Profile Section (shown when logged in) -->
        <div class="user-profile-section" id="userProfileSection" style="display: none;">
            <button class="btn-profile" onclick="window.location.href='profile.html'">
                <i class="fas fa-user-circle"></i>
                <span>Profil</span>
            </button>
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Odhl√°sit se</span>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Toggle Button (when collapsed) -->
    <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content Wrapper -->
    <div class="main-content">
        <!-- Profile Hero Section -->
        <section class="page-hero">
            <div class="container">
                <div class="page-hero-card">
                    <div class="page-hero-inner">
                        <h2 class="services-title"><span class="title-text">Nastaven√≠</span><span class="title-accent"></span></h2>
                        <p class="page-hero-subtitle">Spr√°va va≈°eho √∫ƒçtu a p≈ôedvoleb</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Statistics Cards -->
        <section class="profile-stats-section">
            <div class="container">
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-ad"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">12</div>
                            <div class="stat-label">Aktivn√≠ inzer√°ty</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">4.8</div>
                            <div class="stat-label">Hodnocen√≠</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn" onclick="window.location.href='profile.html'">P≈ôehled</button>
            <button class="tab-btn" onclick="window.location.href='profile-services.html'">Moje slu≈æby</button>
            <button class="tab-btn" onclick="window.location.href='profile-ratings.html'">Hodnocen√≠</button>
            <button class="tab-btn active">Nastaven√≠</button>
            <button class="tab-btn" onclick="window.location.href='profile-plan.html'">Spravovat bal√≠ƒçek</button>
            <button class="tab-btn" onclick="window.location.href='top-ads.html'">Topov√°n√≠</button>
        </div>

        <!-- Settings Content -->
        <div class="settings-content">
            <div class="settings-sections">
                <!-- Personal Information -->
                <div class="settings-section">
                    <h3 class="settings-title">
                        <i class="fas fa-user"></i>
                        Osobn√≠ informace
                    </h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label for="firstName">K≈ôestn√≠ jm√©no</label>
                            <input type="text" id="firstName" value="" class="form-input" placeholder="Zadejte va≈°e k≈ôestn√≠ jm√©no">
                        </div>
                        <div class="form-group">
                            <label for="lastName">P≈ô√≠jmen√≠</label>
                            <input type="text" id="lastName" value="" class="form-input" placeholder="Zadejte va≈°e p≈ô√≠jmen√≠">
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" value="" class="form-input" placeholder="Zadejte v√°≈° email">
                        </div>
                        <div class="form-group">
                            <label for="phone">Telefon</label>
                            <input type="tel" id="phone" value="" class="form-input" placeholder="Zadejte v√°≈° telefon">
                        </div>
                        <div class="form-group">
                            <label for="city">Mƒõsto</label>
                            <input type="text" id="city" value="" class="form-input" placeholder="Zadejte va≈°e mƒõsto">
                        </div>
                        <div class="form-group">
                            <label for="bio">O mnƒõ</label>
                            <textarea id="bio" class="form-input" rows="3" placeholder="Kr√°tk√Ω popis o sobƒõ..."></textarea>
                        </div>
                        <button type="button" onclick="savePersonalInfo()" class="btn-save" data-section="personal">
                            <i class="fas fa-save"></i>
                            Ulo≈æit zmƒõny
                        </button>
                    </div>
                </div>

                <!-- Business Information -->
                <div class="settings-section">
                    <h3 class="settings-title">
                        <i class="fas fa-briefcase"></i>
                        Obchodn√≠ informace
                    </h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label for="businessName">N√°zev firmy</label>
                            <input type="text" id="businessName" value="" class="form-input" placeholder="Zadejte n√°zev firmy">
                        </div>
                        <div class="form-group">
                            <label for="businessType">Typ podnik√°n√≠</label>
                            <select id="businessType" class="form-input">
                                <option value="">Vyberte typ podnik√°n√≠</option>
                                <option value="individual">OSVƒå</option>
                                <option value="company">Spoleƒçnost</option>
                                <option value="freelancer">Freelancer</option>
                                <option value="other">Jin√©</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="businessIco">Iƒå (Identifikaƒçn√≠ ƒç√≠slo)</label>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <input type="text" id="businessIco" value="" class="form-input" placeholder="Zadejte Iƒå firmy" style="flex:1;">
                                <button type="button" id="btnVerifyICOSettings" class="btn-save" style="white-space:nowrap;">
                                    <i class="fas fa-check-circle"></i>
                                    Ovƒõ≈ôit
                                </button>
                            </div>
                            <div id="icoStatusSettings" style="font-size:13px; margin-top:6px; color:#6b7280;"></div>
                        </div>
                        <div class="form-group">
                            <label for="businessDic">DIƒå (Da≈àov√© identifikaƒçn√≠ ƒç√≠slo)</label>
                            <input type="text" id="businessDic" value="" class="form-input" placeholder="Zadejte DIƒå firmy">
                        </div>
                        <div class="form-group">
                            <label for="businessAddress">Adresa firmy</label>
                            <textarea id="businessAddress" class="form-input" rows="2" placeholder="Ulice, mƒõsto, PSƒå"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="businessDescription">Popis podnik√°n√≠</label>
                            <textarea id="businessDescription" class="form-input" rows="4" placeholder="Co dƒõl√°te, jak√© slu≈æby poskytujete..."></textarea>
                        </div>
                        <button class="btn-save" data-section="business" onclick="saveBusinessInfo()">
                            <i class="fas fa-save"></i>
                            Ulo≈æit zmƒõny
                        </button>
                    </div>
                </div>

                <!-- Account Settings -->
                <div class="settings-section">
                    <h3 class="settings-title">
                        <i class="fas fa-cog"></i>
                        Nastaven√≠ √∫ƒçtu
                    </h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label for="currentPassword">Souƒçasn√© heslo</label>
                            <input type="password" id="currentPassword" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Nov√© heslo</label>
                            <input type="password" id="newPassword" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Potvrdit heslo</label>
                            <input type="password" id="confirmPassword" class="form-input">
                        </div>
                        <button class="btn-save" onclick="changePassword()">
                            <i class="fas fa-key"></i>
                            Zmƒõnit heslo
                        </button>
                    </div>
                </div>


                <!-- Danger Zone -->
                <div class="settings-section danger-zone">
                    <h3 class="settings-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Nebezpeƒçn√° z√≥na
                    </h3>
                    <div class="settings-form">
                        <div class="danger-actions">
                            <button class="btn-danger" onclick="deleteAccount()">
                                <i class="fas fa-trash"></i>
                                Smazat √∫ƒçet
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Glob√°ln√≠ promƒõnn√© pro real-time listener
        let profileListener = null;
        let isInitialized = false;

        // Export funkc√≠ pro glob√°ln√≠ pou≈æit√≠ - OKAM≈ΩITƒö (budou nastaveny po definici)

        // Inicializace po naƒçten√≠ DOM
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Inicializuji nastaven√≠ profilu');
            initializeSettings();
            loadUserProfile();
        });

        // Load user profile data
        async function loadUserProfile() {
            console.log('üîß Loading user profile...');
            try {
                // Wait for Firebase to be available
                const checkFirebase = setInterval(() => {
                    console.log('üîç Checking Firebase:', {
                        firebaseAuth: !!window.firebaseAuth,
                        firebaseDb: !!window.firebaseDb
                    });
                    if (window.firebaseAuth && window.firebaseDb) {
                        console.log('‚úÖ Firebase available, loading data');
                        clearInterval(checkFirebase);
                        loadUserData();
                        
                        // Listen for auth state changes
                        window.firebaseAuth.onAuthStateChanged((user) => {
                            console.log('üë§ Auth state changed on profile page:', user ? user.email : 'Not logged in');
                            if (user) {
                                loadUserData();
                            }
                        });
                    }
                }, 100);
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ profilu:', error);
            }
        }

        // Ulo≈æen√≠ osobn√≠ch informac√≠ - DEFINICE HNED
        async function savePersonalInfo() {
            console.log('üöÄ savePersonalInfo vol√°na!');
            try {
                    console.log('üîç Kontroluji Firebase:', {
                        firebaseAuth: !!window.firebaseAuth,
                        firebaseDb: !!window.firebaseDb
                    });
                
                const currentUser = window.firebaseAuth.currentUser;
                console.log('üë§ Aktu√°ln√≠ u≈æivatel:', currentUser ? currentUser.uid : 'NEN√ç P≈òIHL√Å≈†EN');
                
                if (!currentUser) {
                    showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                    return;
                }

                // Z√≠skat hodnoty z formul√°≈ôe
                const firstNameEl = document.getElementById('firstName');
                const lastNameEl = document.getElementById('lastName');
                const emailEl = document.getElementById('email');
                const phoneEl = document.getElementById('phone');
                const cityEl = document.getElementById('city');
                const bioEl = document.getElementById('bio');
                
                console.log('üîç Elementy formul√°≈ôe:', {
                    firstName: !!firstNameEl,
                    lastName: !!lastNameEl,
                    email: !!emailEl,
                    phone: !!phoneEl,
                    city: !!cityEl,
                    bio: !!bioEl
                });
                
                const firstName = firstNameEl ? firstNameEl.value : '';
                const lastName = lastNameEl ? lastNameEl.value : '';
                
                const personalData = {
                    firstName: firstName,
                    lastName: lastName,
                    name: `${firstName} ${lastName}`.trim(), // Zachovat i slo≈æen√© jm√©no pro kompatibilitu
                    email: emailEl ? emailEl.value : '',
                    phone: phoneEl ? phoneEl.value : '',
                    city: cityEl ? cityEl.value : '',
                    bio: bioEl ? bioEl.value : '',
                    updatedAt: new Date()
                };

                console.log('üíæ Ukl√°d√°m osobn√≠ informace:', personalData);

                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                
                console.log('üìù Cesta k dokumentu:', `users/${currentUser.uid}/profile/profile`);
                
                await setDoc(profileRef, personalData, { merge: true });

                console.log('‚úÖ Data √∫spƒõ≈°nƒõ ulo≈æena do Firebase');
                showMessage('‚úÖ Osobn√≠ informace byly ulo≈æeny!', 'success');

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi ukl√°d√°n√≠ osobn√≠ch informac√≠:', error);
                showMessage('Nepoda≈ôilo se ulo≈æit osobn√≠ informace: ' + error.message, 'error');
            }
        }

        // Ulo≈æen√≠ obchodn√≠ch informac√≠ - DEFINICE HNED
        async function saveBusinessInfo() {
            console.log('üöÄ saveBusinessInfo vol√°na!');
            try {
                console.log('üîç Kontroluji Firebase:', {
                    firebaseAuth: !!window.firebaseAuth,
                    firebaseDb: !!window.firebaseDb
                });
                
                const currentUser = window.firebaseAuth.currentUser;
                console.log('üë§ Aktu√°ln√≠ u≈æivatel:', currentUser ? currentUser.uid : 'NEN√ç P≈òIHL√Å≈†EN');
                
                if (!currentUser) {
                    showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                    return;
                }

                // Z√≠skat hodnoty z formul√°≈ôe
                const businessNameEl = document.getElementById('businessName');
                const businessTypeEl = document.getElementById('businessType');
                const businessIcoEl = document.getElementById('businessIco');
                const businessDicEl = document.getElementById('businessDic');
                const businessAddressEl = document.getElementById('businessAddress');
                const businessDescriptionEl = document.getElementById('businessDescription');
                
                console.log('üîç Elementy formul√°≈ôe:', {
                    businessName: !!businessNameEl,
                    businessType: !!businessTypeEl,
                    businessIco: !!businessIcoEl,
                    businessDic: !!businessDicEl,
                    businessAddress: !!businessAddressEl,
                    businessDescription: !!businessDescriptionEl
                });
                
                // Ovƒõ≈ôen√≠ IƒåO ‚Äì pokud je vyplnƒõno, mus√≠ b√Ωt √∫spƒõ≈°nƒõ ovƒõ≈ôeno tlaƒç√≠tkem
                const icoRaw = businessIcoEl ? businessIcoEl.value : '';
                const normalizedIco = normalizeICO(icoRaw);
                if (normalizedIco) {
                    const verifiedFlag = window.__icoVerified === true && window.__icoVerifiedValue === normalizedIco;
                    if (!verifiedFlag) {
                        showMessage('Nejd≈ô√≠ve ovƒõ≈ôte IƒåO tlaƒç√≠tkem Ovƒõ≈ôit.', 'error');
                        return;
                    }
                }

                const businessData = {
                    businessName: businessNameEl ? businessNameEl.value : '',
                    businessType: businessTypeEl ? businessTypeEl.value : '',
                    businessIco: normalizedIco || '',
                    businessDic: businessDicEl ? businessDicEl.value : '',
                    businessAddress: businessAddressEl ? businessAddressEl.value : '',
                    businessDescription: businessDescriptionEl ? businessDescriptionEl.value : '',
                    updatedAt: new Date()
                };

                console.log('üíæ Ukl√°d√°m obchodn√≠ informace:', businessData);

                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                
                console.log('üìù Cesta k dokumentu:', `users/${currentUser.uid}/profile/profile`);
                
                await setDoc(profileRef, businessData, { merge: true });

                console.log('‚úÖ Data √∫spƒõ≈°nƒõ ulo≈æena do Firebase');
                showMessage('‚úÖ Obchodn√≠ informace byly ulo≈æeny!', 'success');

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi ukl√°d√°n√≠ obchodn√≠ch informac√≠:', error);
                showMessage('Nepoda≈ôilo se ulo≈æit obchodn√≠ informace: ' + error.message, 'error');
            }
        }

        // ---- IƒåO ovƒõ≈ôov√°n√≠ (ARES) ----
        function normalizeICO(input) {
            const digits = (input || '').toString().replace(/\D+/g, '');
            return digits.slice(0, 8);
        }

        async function validateICOWithARES(ico) {
            const n = normalizeICO(ico);
            if (n.length !== 8) return { ok: false, reason: 'IƒåO mus√≠ m√≠t 8 ƒç√≠slic.' };

            const fetchWithTimeout = (input, opts = {}) => {
                const { timeoutMs = 3000, ...rest } = opts;
                const ctrl = new AbortController();
                const t = setTimeout(() => ctrl.abort(), timeoutMs);
                return fetch(input, { ...rest, signal: ctrl.signal }).finally(() => clearTimeout(t));
            };

            // --- JSON pokusy (nov√© REST API) ---
            const baseJson = [
                `https://ares.gov.cz/ekonomicke-subjekty-v-be/v1/ekonomicke-subjekty/${n}`,
                `https://ares.gov.cz/ekonomicke-subjekty-v-be/ekonomicke-subjekty/${n}`
            ];
            const localProxy = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
                ? baseJson.map(u => `http://localhost:8010/${u.replace('https://','')}`) : [];
            const jsonCandidates = [
                ...localProxy,
                ...baseJson,
                // Proxies pro CORS
                ...baseJson.map(u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`),
                ...baseJson.map(u => `https://thingproxy.freeboard.io/fetch/${u}`),
                ...baseJson.map(u => `https://cors.isomorphic-git.org/${u}`)
            ];

            for (const directUrl of jsonCandidates) {
                // Direct
                try {
                    const r = await fetchWithTimeout(directUrl, { headers: { 'Accept': 'application/json' }, timeoutMs: 3000 });
                    if (r.ok) {
                        const data = await r.json().catch(() => null);
                        if (data) {
                            const name = data.obchodniJmeno || data.obchodni_name || data.obchodni_jmeno || data.nazevSubjektu || '';
                            const sidlo = data.sidlo || data.s√≠dlo || data.adresaSidla || null;
                            if (name || sidlo) return { ok: true, name, seat: sidlo };
                        }
                    }
                } catch (_) {}
                // Proxy (CORS)
                try {
                    const proxied = `https://api.allorigins.win/raw?url=${encodeURIComponent(directUrl)}`;
                    const r2 = await fetchWithTimeout(proxied, { headers: { 'Accept': 'application/json' }, timeoutMs: 3000 });
                    if (r2.ok) {
                        const data = await r2.json().catch(() => null);
                        if (data) {
                            const name = data.obchodniJmeno || data.obchodni_name || data.obchodni_jmeno || data.nazevSubjektu || '';
                            const sidlo = data.sidlo || data.s√≠dlo || data.adresaSidla || null;
                            if (name || sidlo) return { ok: true, name, seat: sidlo };
                        }
                    }
                } catch (_) {}
            }

            // --- XML fallback (p≈Øvodn√≠ ARES) ---
            const xmlBase = [
                `https://wwwinfo.mfcr.cz/cgi-bin/ares/darv_bas.cgi?ico=${n}&ver=1.0&jazyk=cz`,
                `https://wwwinfo.mfcr.cz/cgi-bin/ares/darv_res.cgi?ico=${n}&ver=1.0&jazyk=cz`
            ];
            const xmlLocal = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
                ? xmlBase.map(u => `http://localhost:8010/${u.replace('https://','')}`) : [];
            const xmlCandidates = [
                ...xmlLocal,
                ...xmlBase,
                ...xmlBase.map(u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`),
                ...xmlBase.map(u => `https://thingproxy.freeboard.io/fetch/${u}`),
                ...xmlBase.map(u => `https://cors.isomorphic-git.org/${u}`)
            ];
            for (const u of xmlCandidates) {
                try {
                    const r = await fetchWithTimeout(u, { timeoutMs: 3000 });
                    if (!r.ok) continue;
                    const xmlText = await r.text();
                    const doc = new DOMParser().parseFromString(xmlText, 'text/xml');
                    const icoNode = doc.querySelector('ICO');
                    const nameNode = doc.querySelector('OF');
                    if (icoNode && icoNode.textContent.replace(/\D+/g, '') === n) {
                        let seatText = '';
                        const ns = doc.querySelector('NS');
                        const n3 = doc.querySelector('N');
                        const cd = doc.querySelector('CD');
                        const co = doc.querySelector('CO');
                        const psc = doc.querySelector('PSC');
                        const p = doc.querySelector('P');
                        const parts = [];
                        if (n3) parts.push(n3.textContent.trim());
                        const num = [cd?.textContent?.trim(), co?.textContent?.trim()].filter(Boolean).join('/');
                        if (num) parts.push(num);
                        if (psc || p) parts.push([psc?.textContent?.trim(), p?.textContent?.trim()].filter(Boolean).join(' '));
                        if (ns) parts.push(ns.textContent.trim());
                        seatText = parts.filter(Boolean).join(', ');
                        return { ok: true, name: nameNode ? nameNode.textContent : '', seat: seatText ? { text: seatText } : null };
                    }
                } catch (_) {}
            }

            return { ok: false, reason: 'Subjekt s t√≠mto IƒåO nebyl nalezen.' };
        }

        // UI logika pro ovƒõ≈ôen√≠ IƒåO v Nastaven√≠
        document.addEventListener('DOMContentLoaded', () => {
            const icoInput = document.getElementById('businessIco');
            const verifyBtn = document.getElementById('btnVerifyICOSettings');
            const statusEl = document.getElementById('icoStatusSettings');
            const nameEl = document.getElementById('businessName');
            const addrEl = document.getElementById('businessAddress');

            // Resetovat flag p≈ôi zmƒõnƒõ IƒåO
            if (icoInput) {
                icoInput.addEventListener('input', () => {
                    window.__icoVerified = false;
                    window.__icoVerifiedValue = '';
                    if (statusEl) { statusEl.style.color = '#6b7280'; statusEl.textContent = ''; }
                });
            }

            if (verifyBtn) {
                verifyBtn.addEventListener('click', async () => {
                    try {
                        verifyBtn.disabled = true;
                        if (statusEl) { statusEl.style.color = '#6b7280'; statusEl.textContent = 'Ovƒõ≈ôuji IƒåO‚Ä¶'; }
                        const val = icoInput ? icoInput.value : '';
                        const res = await validateICOWithARES(val);
                        if (res.ok) {
                            const n = normalizeICO(val);
                            if (icoInput) icoInput.value = n;
                            window.__icoVerified = true;
                            window.__icoVerifiedValue = n;
                            if (statusEl) { statusEl.style.color = '#28a745'; statusEl.textContent = 'IƒåO ovƒõ≈ôeno'; }
                            // P≈ôedvyplnit n√°zev/s√≠dlo pokud pr√°zdn√©
                            if (res.name && nameEl && !nameEl.value) nameEl.value = res.name;
                            if (res.seat && addrEl && !addrEl.value && res.seat.text) addrEl.value = res.seat.text;
                        } else {
                            window.__icoVerified = false;
                            window.__icoVerifiedValue = '';
                            if (statusEl) { statusEl.style.color = '#dc3545'; statusEl.textContent = res.reason || 'IƒåO se nepoda≈ôilo ovƒõ≈ôit'; }
                        }
                    } finally {
                        verifyBtn.disabled = false;
                    }
                });
            }
        });

        // Ulo≈æen√≠ p≈ôedvoleb - DEFINICE HNED
        async function savePreferences() {
            console.log('üöÄ savePreferences vol√°na!');
            try {
                console.log('üîç Kontroluji Firebase:', {
                    firebaseAuth: !!window.firebaseAuth,
                    firebaseDb: !!window.firebaseDb
                });
                
                const currentUser = window.firebaseAuth.currentUser;
                console.log('üë§ Aktu√°ln√≠ u≈æivatel:', currentUser ? currentUser.uid : 'NEN√ç P≈òIHL√Å≈†EN');
                
                if (!currentUser) {
                    showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                    return;
                }

                // Z√≠skat hodnoty z formul√°≈ôe
                const emailNotificationsEl = document.getElementById('emailNotifications');
                const smsNotificationsEl = document.getElementById('smsNotifications');
                const marketingEmailsEl = document.getElementById('marketingEmails');
                
                console.log('üîç Elementy formul√°≈ôe:', {
                    emailNotifications: !!emailNotificationsEl,
                    smsNotifications: !!smsNotificationsEl,
                    marketingEmails: !!marketingEmailsEl
                });
                
                const preferencesData = {
                    emailNotifications: emailNotificationsEl ? emailNotificationsEl.checked : true,
                    smsNotifications: smsNotificationsEl ? smsNotificationsEl.checked : false,
                    marketingEmails: marketingEmailsEl ? marketingEmailsEl.checked : false,
                    updatedAt: new Date()
                };

                console.log('üíæ Ukl√°d√°m p≈ôedvolby:', preferencesData);

                const { setDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                
                console.log('üìù Cesta k dokumentu:', `users/${currentUser.uid}/profile/profile`);
                
                await setDoc(profileRef, preferencesData, { merge: true });

                console.log('‚úÖ Data √∫spƒõ≈°nƒõ ulo≈æena do Firebase');
                showMessage('‚úÖ P≈ôedvolby byly ulo≈æeny!', 'success');

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi ukl√°d√°n√≠ p≈ôedvoleb:', error);
                showMessage('Nepoda≈ôilo se ulo≈æit p≈ôedvolby: ' + error.message, 'error');
            }
        }

        // Zmƒõna hesla - DEFINICE HNED
        async function changePassword() {
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    showMessage('Mus√≠te b√Ωt p≈ôihl√°≈°eni!', 'error');
                    return;
                }

                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // Validace
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showMessage('Vypl≈àte v≈°echna pole!', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showMessage('Nov√° hesla se neshoduj√≠!', 'error');
                    return;
                }

                if (newPassword.length < 6) {
                    showMessage('Nov√© heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø!', 'error');
                    return;
                }

                console.log('üîë Mƒõn√≠m heslo...');

                // Re-autentifikace s aktu√°ln√≠m heslem
                const { reauthenticateWithCredential, EmailAuthProvider } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                
                await reauthenticateWithCredential(currentUser, credential);

                // Zmƒõna hesla
                const { updatePassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                await updatePassword(currentUser, newPassword);

                // Vyƒçistit formul√°≈ô
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

                showMessage('‚úÖ Heslo bylo √∫spƒõ≈°nƒõ zmƒõnƒõno!', 'success');
                console.log('‚úÖ Heslo √∫spƒõ≈°nƒõ zmƒõnƒõno');

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi zmƒõnƒõ hesla:', error);
                
                let errorMessage = 'Nepoda≈ôilo se zmƒõnit heslo';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Souƒçasn√© heslo je nespr√°vn√©';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Nov√© heslo je p≈ô√≠li≈° slab√©';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Pro zmƒõnu hesla se mus√≠te znovu p≈ôihl√°sit';
                }
                
                showMessage(errorMessage, 'error');
            }
        }

        // Zobrazen√≠ zpr√°vy - DEFINICE HNED
        function showMessage(message, type = 'info') {
            // Odstranit existuj√≠c√≠ zpr√°vy
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Stylov√°n√≠
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 2rem;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                min-width: 300px;
                font-size: 14px;
            `;
            
            if (type === 'success') {
                messageDiv.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                messageDiv.style.backgroundColor = '#dc3545';
            } else {
                messageDiv.style.backgroundColor = '#007bff';
            }
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    messageDiv.remove();
                }, 300);
            }, 4000);
        }

        // Delete account function
        async function deleteAccount() {
            // Show confirmation modal
            const confirmationText = prompt(`
‚ö†Ô∏è VAROV√ÅN√ç: NEVRATN√Å AKCE ‚ö†Ô∏è

Opravdu chcete smazat sv≈Øj √∫ƒçet?

Tato akce je NEVRATN√Å a nelze ji vz√≠t zpƒõt!
V≈°echna va≈°e data budou trvale smaz√°na:
- V√°≈° profil a osobn√≠ informace
- V≈°echny va≈°e inzer√°ty a slu≈æby
- V≈°echny recenze a hodnocen√≠
- V≈°echny zpr√°vy a konverzace
- V≈°echna historick√° data

PO PO≈Ω√ÅD√ÅN√ç O SMAZ√ÅN√ç NELZE POD√ÅVAT REKLAMACE!

Pro potvrzen√≠ zadejte p≈ôesnƒõ: smazat
            `);

            if (confirmationText !== "smazat") {
                if (confirmationText !== null) {
                    alert("‚ùå Nespr√°vn√© potvrzen√≠. Smaz√°n√≠ √∫ƒçtu bylo zru≈°eno.");
                }
                return;
            }

            // Second confirmation
            const finalConfirmation = confirm(`
üö® FIN√ÅLN√ç POTVRZEN√ç üö®

Opravdu chcete trvale smazat sv≈Øj √∫ƒçet?

Tato akce je NEVRATN√Å!
V≈°echna va≈°e data budou nav≈ædy ztracena!

Kliknƒõte OK pro pokraƒçov√°n√≠ nebo Storno pro zru≈°en√≠.
            `);

            if (!finalConfirmation) {
                alert("‚ùå Smaz√°n√≠ √∫ƒçtu bylo zru≈°eno.");
                return;
            }

            try {
                // Show loading message
                alert("üîÑ Ma≈æu v√°≈° √∫ƒçet... Pros√≠m poƒçkejte.");
                
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    alert("‚ùå U≈æivatel nen√≠ p≈ôihl√°≈°en.");
                    return;
                }

                // Import Firebase functions
                const { 
                    deleteDoc, 
                    doc, 
                    collection, 
                    getDocs, 
                    query, 
                    where
                } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const { deleteUser } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');

                console.log('üóëÔ∏è Zaƒç√≠n√°m maz√°n√≠ √∫ƒçtu pro u≈æivatele:', currentUser.uid);

                // Delete user profile
                try {
                    await deleteDoc(doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile'));
                    console.log('‚úÖ Profil smaz√°n');
                } catch (error) {
                    console.log('‚ö†Ô∏è Profil nebyl nalezen nebo ji≈æ byl smaz√°n');
                }

                // Delete all user ads
                try {
                    const adsCollection = collection(window.firebaseDb, 'users', currentUser.uid, 'inzeraty');
                    const adsSnapshot = await getDocs(adsCollection);
                    const deletePromises = adsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    console.log('‚úÖ V≈°echny inzer√°ty smaz√°ny');
                } catch (error) {
                    console.log('‚ö†Ô∏è Inzer√°ty nebyly nalezeny nebo ji≈æ byly smaz√°ny');
                }

                // Delete all reviews for this user
                try {
                    const reviewsQuery = query(
                        collection(window.firebaseDb, 'reviews'),
                        where('reviewedUserId', '==', currentUser.uid)
                    );
                    const reviewsSnapshot = await getDocs(reviewsQuery);
                    const deleteReviewPromises = reviewsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deleteReviewPromises);
                    console.log('‚úÖ V≈°echny recenze smaz√°ny');
                } catch (error) {
                    console.log('‚ö†Ô∏è Recenze nebyly nalezeny nebo ji≈æ byly smaz√°ny');
                }

                // Delete all messages from this user
                try {
                    const messagesQuery = query(
                        collection(window.firebaseDb, 'messages'),
                        where('userId', '==', currentUser.uid)
                    );
                    const messagesSnapshot = await getDocs(messagesQuery);
                    const deleteMessagePromises = messagesSnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deleteMessagePromises);
                    console.log('‚úÖ V≈°echny zpr√°vy smaz√°ny');
                } catch (error) {
                    console.log('‚ö†Ô∏è Zpr√°vy nebyly nalezeny nebo ji≈æ byly smaz√°ny');
                }

                // Delete Firebase Auth user
                await deleteUser(window.firebaseAuth, currentUser);
                console.log('‚úÖ Firebase Auth u≈æivatel smaz√°n');

                // Success message
                alert(`
‚úÖ √öƒåET BYL √öSPƒö≈†Nƒö SMAZ√ÅN

V√°≈° √∫ƒçet a v≈°echna souvisej√≠c√≠ data byla trvale smaz√°na.
Budete p≈ôesmƒõrov√°ni na hlavn√≠ str√°nku.
                `);

                // Redirect to home page
                window.location.href = 'index.html';

            } catch (error) {
                console.error('‚ùå Chyba p≈ôi maz√°n√≠ √∫ƒçtu:', error);
                alert(`
‚ùå CHYBA P≈òI MAZ√ÅN√ç √öƒåTU

Do≈°lo k chybƒõ: ${error.message}

Pros√≠m kontaktujte podporu.
                `);
            }
        }

        // EXPORT FUNKC√ç - HNED PO DEFINICI
        window.savePersonalInfo = savePersonalInfo;
        window.saveBusinessInfo = saveBusinessInfo;
        window.savePreferences = savePreferences;
        window.changePassword = changePassword;
        window.deleteAccount = deleteAccount;
        window.showMessage = showMessage;
        
        console.log('‚úÖ Funkce exportov√°ny:', {
            savePersonalInfo: typeof window.savePersonalInfo,
            saveBusinessInfo: typeof window.saveBusinessInfo,
            savePreferences: typeof window.savePreferences,
            changePassword: typeof window.changePassword
        });

        // Hlavn√≠ inicializaƒçn√≠ funkce
        async function initializeSettings() {
            try {
                // Poƒçkat na Firebase
                await waitForFirebase();
                
                // Naƒç√≠st data u≈æivatele (automaticky prefilled)
                await loadUserSettings();
                
                // Nastavit real-time listener
                setupRealtimeListener();
                
                // Nastavit event listenery pro formul√°≈ôe
                setupFormListeners();
                
                // Automatick√© naƒç√≠t√°n√≠ dat p≈ôi r≈Øzn√Ωch ud√°lostech
                setupAutoRefresh();
                
                isInitialized = true;
                console.log('‚úÖ Nastaven√≠ profilu inicializov√°no s automatick√Ωm prefilled daty');
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi inicializaci:', error);
                showMessage('Chyba p≈ôi naƒç√≠t√°n√≠ nastaven√≠', 'error');
            }
        }

        // Nastaven√≠ automatick√©ho naƒç√≠t√°n√≠ dat
        function setupAutoRefresh() {
            // Automatick√© naƒç√≠t√°n√≠ p≈ôi focus na str√°nku
            window.addEventListener('focus', () => {
                if (isInitialized) {
                    console.log('üîÑ Automatick√© naƒç√≠t√°n√≠ dat p≈ôi focus');
                    loadUserSettings();
                }
            });

            // Automatick√© naƒç√≠t√°n√≠ p≈ôi n√°vratu na str√°nku (visibility change)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && isInitialized) {
                    console.log('üîÑ Automatick√© naƒç√≠t√°n√≠ dat p≈ôi n√°vratu na str√°nku');
                    loadUserSettings();
                }
            });

            // Automatick√© naƒç√≠t√°n√≠ p≈ôi zmƒõnƒõ auth stavu
            if (window.firebaseAuth) {
                window.firebaseAuth.onAuthStateChanged((user) => {
                    if (user && isInitialized) {
                        console.log('üîÑ Automatick√© naƒç√≠t√°n√≠ dat p≈ôi zmƒõnƒõ auth stavu');
                        loadUserSettings();
                    }
                });
            }

            // Automatick√© naƒç√≠t√°n√≠ ka≈æd√Ωch 30 sekund (pokud je str√°nka aktivn√≠)
            setInterval(() => {
                if (!document.hidden && isInitialized) {
                    console.log('üîÑ Automatick√© naƒç√≠t√°n√≠ dat (30s interval)');
                    loadUserSettings();
                }
            }, 30000);
        }

        // Poƒçkat na Firebase
        async function waitForFirebase() {
            return new Promise((resolve, reject) => {
                const checkFirebase = setInterval(() => {
                    if (window.firebaseAuth && window.firebaseDb) {
                        clearInterval(checkFirebase);
                        resolve();
                    }
                }, 100);
                
                // Timeout po 10 sekund√°ch
                setTimeout(() => {
                    clearInterval(checkFirebase);
                    reject(new Error('Firebase se nenaƒçetl'));
                }, 10000);
            });
        }

        // Automatick√© naƒçten√≠ nastaven√≠ u≈æivatele
        async function loadUserSettings() {
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    console.log('‚ö†Ô∏è U≈æivatel nen√≠ p≈ôihl√°≈°en');
                    return;
                }

                console.log('üîÑ Automaticky naƒç√≠t√°m data pro u≈æivatele:', currentUser.uid);

                const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                const profileSnap = await getDoc(profileRef);
                
                let userProfile = null;
                if (profileSnap.exists()) {
                    userProfile = profileSnap.data();
                    console.log('‚úÖ Automaticky naƒçten√Ω profil:', userProfile);
                } else {
                    // Pokud profil neexistuje, vytvo≈ôit z√°kladn√≠ strukturu s aktu√°ln√≠mi daty u≈æivatele
                    const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || '';
                    const nameParts = displayName.split(' ');
                    
                    userProfile = {
                        firstName: nameParts[0] || '',
                        lastName: nameParts.slice(1).join(' ') || '',
                        name: displayName, // Zachovat slo≈æen√© jm√©no pro kompatibilitu
                        email: currentUser.email || '',
                        phone: '',
                        city: '',
                        bio: '',
                        businessName: '',
                        businessType: '',
                        businessIco: '',
                        businessDic: '',
                        businessAddress: '',
                        businessDescription: '',
                        emailNotifications: true,
                        smsNotifications: false,
                        marketingEmails: false,
                        createdAt: new Date()
                    };
                    
                    // Ulo≈æit z√°kladn√≠ profil
                    const { setDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    await setDoc(profileRef, userProfile, { merge: true });
                    console.log('‚úÖ Automaticky vytvo≈ôen z√°kladn√≠ profil:', userProfile);
                }

                // Automaticky aktualizovat formul√°≈ô s daty (v≈ædy prefilled)
                updateFormFields(userProfile);
                
                // Tich√° notifikace o √∫spƒõ≈°n√©m naƒçten√≠ (pouze p≈ôi prvn√≠m naƒçten√≠)
                if (!window.dataLoaded) {
                    console.log('‚úÖ Data automaticky naƒçtena a formul√°≈ô prefilled');
                    window.dataLoaded = true;
                }
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi automatick√©m naƒç√≠t√°n√≠ nastaven√≠:', error);
                // Tich√° chyba - neobtƒõ≈æovat u≈æivatele notifikacemi
            }
        }

        // Real-time listener pro zmƒõny v profilu
        function setupRealtimeListener() {
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) return;

                const { onSnapshot, doc } = import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                onSnapshot.then(({ onSnapshot }) => {
                    const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                    
                    profileListener = onSnapshot(profileRef, (snapshot) => {
                        if (snapshot.exists()) {
                            const userProfile = snapshot.data();
                            console.log('üîÑ Real-time aktualizace profilu:', userProfile);
                            
                            // Aktualizovat pouze pokud u≈æivatel neupravuje formul√°≈ô
                            const activeElement = document.activeElement;
                            const isEditing = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'SELECT');
                            
                            if (!isEditing) {
                                updateFormFields(userProfile);
                            }
                        }
                    }, (error) => {
                        console.error('‚ùå Chyba real-time listeneru:', error);
                    });
                });
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi nastaven√≠ real-time listeneru:', error);
            }
        }

        // Nastaven√≠ event listener≈Ø pro formul√°≈ôe
        function setupFormListeners() {
            // Auto-save p≈ôi zmƒõnƒõ hodnot (s debounce)
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                let timeout;
                input.addEventListener('input', () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        // Oznaƒçit, ≈æe byly provedeny zmƒõny
                        input.classList.add('modified');
                    }, 500);
                });
            });
        }

        // Aktualizace formul√°≈ôov√Ωch pol√≠ s daty (v≈ædy prefilled kromƒõ hesel)
        function updateFormFields(userProfile) {
            console.log('üîÑ Aktualizuji formul√°≈ô s daty:', userProfile);
            
            // Osobn√≠ informace - v≈ædy prefilled
            const personalFields = {
                'firstName': userProfile?.firstName || '',
                'lastName': userProfile?.lastName || '',
                'email': userProfile?.email || '',
                'phone': userProfile?.phone || '',
                'city': userProfile?.city || '',
                'bio': userProfile?.bio || ''
            };

            Object.entries(personalFields).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = value;
                    element.placeholder = value ? `Aktu√°ln√≠: ${value}` : 'Zadejte hodnotu';
                }
            });

            // Obchodn√≠ informace - v≈ædy prefilled
            const businessFields = {
                'businessName': userProfile?.businessName || '',
                'businessType': userProfile?.businessType || '',
                'businessIco': userProfile?.businessIco || '',
                'businessDic': userProfile?.businessDic || '',
                'businessAddress': userProfile?.businessAddress || '',
                'businessDescription': userProfile?.businessDescription || ''
            };

            Object.entries(businessFields).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = value;
                    element.placeholder = value ? `Aktu√°ln√≠: ${value}` : 'Zadejte hodnotu';
                }
            });

            // P≈ôedvolby - v≈ædy prefilled
            const preferenceFields = {
                'emailNotifications': userProfile?.emailNotifications !== false,
                'smsNotifications': userProfile?.smsNotifications === true,
                'marketingEmails': userProfile?.marketingEmails === true
            };

            Object.entries(preferenceFields).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.checked = value;
                }
            });
            
            // Hesla - NIKDY neprefilled (z≈Øst√°vaj√≠ pr√°zdn√°)
            const passwordFields = ['currentPassword', 'newPassword', 'confirmPassword'];
            passwordFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = ''; // V≈ædy pr√°zdn√©
                    element.placeholder = 'Zadejte heslo';
                }
            });
            
            console.log('‚úÖ Formul√°≈ô aktualizov√°n s prefilled daty (kromƒõ hesel)');
        }

        // CSS pro animace
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .modified {
                border-color: #007bff !important;
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25) !important;
            }
        `;
        document.head.appendChild(style);

        // Cleanup p≈ôi opu≈°tƒõn√≠ str√°nky
        window.addEventListener('beforeunload', () => {
            if (profileListener) {
                profileListener();
            }
        });

        // Load actual user data
        async function loadUserData() {
            console.log('üíæ Loading user data...');
            try {
                const currentUser = window.firebaseAuth.currentUser;
                if (!currentUser) {
                    console.log('‚ö†Ô∏è U≈æivatel nen√≠ p≈ôihl√°≈°en');
                    return;
                }

                console.log('üë§ Naƒç√≠t√°m data pro u≈æivatele:', currentUser.uid);

                // Load user profile from Firestore
                const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const profileRef = doc(window.firebaseDb, 'users', currentUser.uid, 'profile', 'profile');
                const profileSnap = await getDoc(profileRef);
                
                let userProfile = null;
                if (profileSnap.exists()) {
                    userProfile = profileSnap.data();
                }

                // Load user ads to get statistics
                const { getDocs, collection } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const adsRef = collection(window.firebaseDb, 'users', currentUser.uid, 'inzeraty');
                const adsSnapshot = await getDocs(adsRef);
                
                const userAds = [];
                adsSnapshot.forEach((doc) => {
                    userAds.push({ id: doc.id, ...doc.data() });
                });

                // Update statistics
                console.log('üìä Calling updateStatistics with:', { userAds: userAds.length, userProfile });
                updateStatistics(userAds, userProfile);
                
                // Load all reviews and update rating after loading
                loadAllUserReviews(currentUser.uid);

            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat u≈æivatele:', error);
            }
        }

        // Update statistics with real data
        function updateStatistics(userAds, userProfile) {
            console.log('üìä Updating statistics:', { userAds, userProfile });
            
            // Active ads count
            const activeAds = userAds ? userAds.filter(ad => ad.status === 'active').length : 0;
            const activeAdsElement = document.querySelector('.stat-card:nth-child(1) .stat-number');
            if (activeAdsElement) {
                activeAdsElement.textContent = activeAds > 0 ? activeAds : '-';
                console.log('üìù Updated active ads:', activeAds);
            }

            // Rating will be updated after loading reviews
            const ratingElement = document.querySelector('.stat-card:nth-child(2) .stat-number');
            if (ratingElement) {
                ratingElement.textContent = '-';
            }
            
            console.log('‚úÖ Statistics updated');
        }

        // Load all user reviews (profile + ads)
        async function loadAllUserReviews(userId) {
            console.log('‚≠ê Loading all reviews for user:', userId);
            try {
                const { getDocs, collection, collectionGroup } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                // Load profile reviews
                const profileReviewsRef = collection(window.firebaseDb, 'users', userId, 'reviews');
                const profileSnap = await getDocs(profileReviewsRef);
                const profileReviews = profileSnap.docs.map(d => ({ 
                    id: d.id, 
                    ...d.data(),
                    type: 'profile'
                }));

                // Load ad reviews using collectionGroup
                const adReviewsGroup = collectionGroup(window.firebaseDb, 'reviews');
                const adReviews = [];
                const groupSnap = await getDocs(adReviewsGroup);
                groupSnap.forEach(docSnap => {
                    const parent = docSnap.ref.parent; // reviews collection
                    const adDoc = parent?.parent; // adId document
                    const inzeraty = adDoc?.parent; // 'inzeraty' collection
                    const userDoc = inzeraty?.parent; // user uid document
                    if (userDoc && userDoc.id === userId && inzeraty.id === 'inzeraty') {
                        adReviews.push({ 
                            id: docSnap.id, 
                            ...docSnap.data(),
                            type: 'ad',
                            adId: adDoc.id
                        });
                    }
                });

                // Combine all reviews
                const allReviews = [...profileReviews, ...adReviews];
                console.log('üìä Found reviews:', { 
                    profile: profileReviews.length, 
                    ads: adReviews.length, 
                    total: allReviews.length 
                });

                // Update rating in statistics after loading reviews
                updateRatingFromReviews(allReviews);

            } catch (error) {
                console.error('‚ùå Error loading reviews:', error);
            }
        }

        // Update rating in statistics from reviews
        function updateRatingFromReviews(reviews) {
            console.log('üîÑ Updating rating from reviews:', reviews.length);
            
            // Calculate average rating
            const avgRating = reviews.length > 0 ? 
                (reviews.reduce((sum, r) => sum + (r.rating || 0), 0) / reviews.length) : 0;
            
            const ratingElement = document.querySelector('.stat-card:nth-child(2) .stat-number');
            if (ratingElement) {
                if (reviews.length > 0) {
                    ratingElement.textContent = avgRating.toFixed(1);
                } else {
                    ratingElement.textContent = '-';
                }
                console.log('üìù Updated rating from reviews:', avgRating.toFixed(1), 'reviews:', reviews.length);
            }
        }
    </script>
    <!-- Naƒçten√≠ skript≈Ø pro spr√°vn√© zobrazen√≠ navbaru -->
    <script src="script.js" defer></script>
    <script src="auth.js" defer></script>
</body>
</html>
